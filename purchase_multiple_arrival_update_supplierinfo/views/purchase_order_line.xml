<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- PO tree -->
    <record id="purchase_order_line_arrival_date_tree" model="ir.ui.view">
        <field name="name">purchase.order.line.tree.multiple_arrival_update_supplier_info</field>
        <field name="model">purchase.order.line</field>
        <field name="inherit_id" ref="purchase.purchase_order_line_tree" />
        <field name="mode">primary</field>
        <field name="priority">9999</field>

        <field name="arch" type="xml">
            <!-- Make editable (especially for `price_unit`) -->
            <tree position="attributes">
                <attribute name="editable">top</attribute>
            </tree>

            <!-- Add (un)verify button when groupping by `date_arrival_id` -->
            <tree position="inside">
                <field name="product_uom_category_id" invisible="1" />

                <groupby name="date_arrival_id">
                    <field name="verified" invisible="1" />
                    <button type="object" name="action_verify_toggle"
                        icon="fa-check" string="Mark as verified"
                        attrs="{'invisible': [('verified', '=', True)]}"
                    />
                    <button type="object" name="action_verify_toggle"
                        icon="fa-undo" string="Mark as un-verified"
                        attrs="{'invisible': [('verified', '=', False)]}"
                    />
                </groupby>
            </tree>

            <!-- Add *update* supplierinfo buttons at left -->
            <field name="price_subtotal" position="before">
                <field name="vendor_price_update" invisible="1" />
                <field name="vendor_discount_update" invisible="1" />
                <button type="object" name="action_update_supplierinfo_cost"
                    icon="fa-refresh" string="Update vendor cost"
                    attrs="{'invisible': [('vendor_price_update', '=', False)]}"
                />
                <button type="object" name="action_update_supplierinfo_discount"
                    icon="fa-refresh" string="Update vendor discount"
                    attrs="{'invisible': [('vendor_discount_update', '=', False)]}"
                />
            </field>

            <!-- Adapt/Hide existing fields -->
            <field name="order_id" position="attributes">
                <attribute name="invisible">1</attribute>
            </field>
            <field name="product_uom" position="attributes">
                <attribute name="optional">hide</attribute>
            </field>
            <field name="price_subtotal" position="attributes">
                <attribute name="optional">show</attribute>
            </field>
            <field name="date_planned" position="attributes">
                <attribute name="optional">hide</attribute>
            </field>
        </field>
    </record>

    <!-- PO lines search -->
    <record id="purchase_order_line_search" model="ir.ui.view">
        <field name="name">purchase.order.line.search.multiple_arrival_update_supplier_info</field>
        <field name="model">purchase.order.line</field>
        <field name="inherit_id" ref="purchase.purchase_order_line_search" />

        <field name="arch" type="xml">
            <!-- Add filtering possibilities by `date_arrival_id.verified` -->
            <group position="before">
                <separator />
                <filter name="date_arrival_unverified"  string="Acknowledged by supplier, not verified" domain="[('date_arrival_id', '!=', False), ('date_arrival_id.verified', '=', False)]" />
                <filter name="date_arrival_verified"    string="Acknowledged by supplier, verified"     domain="[('date_arrival_id', '!=', False), ('date_arrival_id.verified', '=', True)]" />
                <filter name="date_arrival_none"        string="Not acknowledged by supplier"           domain="[('date_arrival_id', '=', False)]" />
            </group>

            <!-- Groupby `date_arrival_id` -->
            <group position="inside">
                <filter name="groupby_date_arrival" string="Arrival Date" context="{'group_by': 'date_arrival_id'}" />
            </group>
        </field>
    </record>

    <!-- PO lines action & menu-item -->
    <record id="action_open_po_lines_acknowledged" model="ir.actions.act_window">
        <field name="name">Acknowledged Purchase Order Lines</field>
        <field name="res_model">purchase.order.line</field>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="purchase_order_line_arrival_date_tree" />
        <field name="context">{
            'search_default_date_arrival_unverified': 1,
            'search_default_order_reference': 1,
            'search_default_groupby_date_arrival': 1,
        }</field>
    </record>
    <menuitem id="purchase_po_lines_acknowledged"
        action="action_open_po_lines_acknowledged"
        parent="purchase.purchase_report_main"
    />

</odoo>
